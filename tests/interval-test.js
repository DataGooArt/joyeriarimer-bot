// interval-test.js

require('dotenv').config();
const axios = require('axios');

// --- CONFIGURACI√ìN ---
const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_NUMBER_ID = process.env.WHATSAPP_PHONE_NUMBER_ID;
const TO_PHONE_NUMBER = process.env.TO_PHONE_NUMBER; // Leemos el n√∫mero desde el archivo .env

if (!WHATSAPP_TOKEN || !WHATSAPP_PHONE_NUMBER_ID || !TO_PHONE_NUMBER) {
    console.error("Error: Aseg√∫rate de que WHATSAPP_TOKEN, WHATSAPP_PHONE_NUMBER_ID y TO_PHONE_NUMBER est√©n en tu archivo .env");
    process.exit(1);
}

// --- FUNCIONES DE ENV√çO ---

/**
 * Funci√≥n base para enviar cualquier tipo de mensaje a la API Graph.
 * @param {object} data - El payload del mensaje a enviar.
 */
async function sendMessageAPI(data) {
    try {
        await axios({
            method: 'POST',
            url: `https://graph.facebook.com/v23.0/${WHATSAPP_PHONE_NUMBER_ID}/messages`,
            headers: {
                'Authorization': `Bearer ${WHATSAPP_TOKEN}`,
                'Content-Type': 'application/json'
            },
            data: data
        });
        console.log(`‚úÖ Mensaje de tipo '${data.type}' enviado a ${data.to}`);
    } catch (error) {
        console.error(`‚ùå Error al enviar mensaje de tipo '${data.type}':`, error.response ? JSON.stringify(error.response.data, null, 2) : error.message);
    }
}

/**
 * Env√≠a un mensaje de texto simple.
 */
async function sendTextMessage(to, text) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'text',
        text: { body: text }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje con una imagen desde una URL.
 */
async function sendImageMessage(to, imageUrl, caption) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'image',
        image: {
            link: imageUrl,
            caption: caption
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje con categor√≠as principales de joyer√≠a.
 */
async function sendCategoriesMessage(to) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: 'üíé ¬°Bienvenido a Joyer√≠a Rimer! ¬øQu√© tipo de joya te interesa?\n\nElige una categor√≠a para ver nuestros productos m√°s populares:'
            },
            action: {
                buttons: [
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_anillos',
                            title: 'üíç Anillos'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_cadenas',
                            title: 'üîó Cadenas & Collares'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_aretes',
                            title: 'üíé Aretes'
                        }
                    }
                ]
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a productos populares de Anillos.
 */
async function sendAnillosProducts(to) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: 'üíç ANILLOS M√ÅS POPULARES\n\nDescubre nuestras piezas m√°s solicitadas:\n\n‚ú® Anillo Solitario Cl√°sico - desde $2,500\n‚ú® Anillo de Compromiso Halo - desde $3,200\n‚ú® Anillo Eternidad - desde $1,800\n\n¬øCu√°l te interesa?'
            },
            action: {
                buttons: [
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_solitario',
                            title: 'Ver Solitario'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_halo',
                            title: 'Ver Halo'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_eternidad',
                            title: 'Ver Eternidad'
                        }
                    }
                ]
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a productos populares de Cadenas y Collares.
 */
async function sendCadenasProducts(to) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: 'üîó CADENAS & COLLARES M√ÅS POPULARES\n\nNuestras piezas m√°s elegantes:\n\n‚ú® Cadena Tenis Diamante - desde $4,500\n‚ú® Collar Coraz√≥n Oro 18k - desde $1,200\n‚ú® Cadena Cl√°sica Oro - desde $800\n\n¬øCu√°l prefieres?'
            },
            action: {
                buttons: [
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_tenis',
                            title: 'Ver Tenis'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_corazon',
                            title: 'Ver Coraz√≥n'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_clasica',
                            title: 'Ver Cl√°sica'
                        }
                    }
                ]
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a productos populares de Aretes.
 */
async function sendAretesProducts(to) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: 'üíé ARETES M√ÅS POPULARES\n\nLos favoritos de nuestras clientas:\n\n‚ú® Aretes Bot√≥n Diamante - desde $1,500\n‚ú® Aretes Colgantes Perla - desde $900\n‚ú® Aretes Aro Oro 18k - desde $650\n\n¬øCu√°l te gusta m√°s?'
            },
            action: {
                buttons: [
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_boton',
                            title: 'Ver Bot√≥n'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_colgante',
                            title: 'Ver Colgante'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'prod_aro',
                            title: 'Ver Aro'
                        }
                    }
                ]
            }
        }
    };
    await sendImageMessage(to, "https://i.imgur.com/example-aretes.jpg", ""); // Imagen opcional
    await sendMessageAPI(data);
}

/**
 * Env√≠a detalles de un producto espec√≠fico con imagen.
 */
async function sendProductDetail(to, productId) {
    const products = {
        'prod_solitario': {
            name: 'Anillo Solitario Cl√°sico',
            price: '$2,500 - $8,500',
            description: 'üíç ANILLO SOLITARIO CL√ÅSICO\n\n‚ú® Diamante central desde 0.5ct\nüî∂ Oro blanco, amarillo o ros√© 14k/18k\nüíé Certificado de autenticidad incluido\nüéÅ Perfecto para compromiso\n\n¬øTe interesa conocer m√°s detalles o agendar una cita para verlo?',
            image: 'https://github.com/user-attachments/assets/9c7e2e5f-4b7e-46b3-82c5-6d1b4e37a2e3'
        },
        'prod_halo': {
            name: 'Anillo de Compromiso Halo',
            price: '$3,200 - $12,000',
            description: 'üíç ANILLO HALO RADIANTE\n\n‚ú® Diamante central rodeado de peque√±os diamantes\nüî∂ Oro blanco 18k (disponible en otros metales)\nüíé Efecto de mayor brillo y tama√±o\nüéÅ Dise√±o rom√°ntico y elegante\n\n¬øTe gustar√≠a ver m√°s modelos o agendar una cita?',
            image: 'https://i.imgur.com/example-halo.jpg'
        },
        'prod_eternidad': {
            name: 'Anillo Eternidad',
            price: '$1,800 - $5,500',
            description: 'üíç ANILLO ETERNIDAD\n\n‚ú® Diamantes alrededor de toda la banda\nüî∂ Oro blanco o amarillo 14k/18k\nüíé S√≠mbolo de amor eterno\nüéÅ Ideal para aniversario o matrimonio\n\n¬øQuieres ver otras opciones o necesitas m√°s informaci√≥n?',
            image: 'https://i.imgur.com/example-eternidad.jpg'
        },
        'prod_tenis': {
            name: 'Cadena Tenis Diamante',
            price: '$4,500 - $15,000',
            description: 'üîó CADENA TENIS DIAMANTE\n\n‚ú® Diamantes de laboratorio o naturales\nüî∂ Oro blanco 18k con cierre de seguridad\nüíé Brillos incomparables\nüéÅ Elegancia para cualquier ocasi√≥n\n\n¬øTe interesa una cotizaci√≥n personalizada?',
            image: 'https://i.imgur.com/example-tenis.jpg'
        },
        'prod_corazon': {
            name: 'Collar Coraz√≥n Oro 18k',
            price: '$1,200 - $3,500',
            description: 'üîó COLLAR CORAZ√ìN ORO 18K\n\n‚ú® Dije en forma de coraz√≥n\nüî∂ Oro amarillo, blanco o ros√©\nüíé Opci√≥n con diamantes peque√±os\nüéÅ Regalo perfecto para ser querida\n\n¬øQuieres personalizarlo con grabado?',
            image: 'https://i.imgur.com/example-corazon.jpg'
        },
        'prod_clasica': {
            name: 'Cadena Cl√°sica Oro',
            price: '$800 - $2,200',
            description: 'üîó CADENA CL√ÅSICA ORO\n\n‚ú® Dise√±o atemporal y elegante\nüî∂ Oro 14k o 18k, varios largos\nüíé Perfecta para usar sola o con dije\nüéÅ B√°sico esencial en joyer√≠a\n\n¬øPrefieres verla en tienda o necesitas medidas?',
            image: 'https://i.imgur.com/example-clasica.jpg'
        }
    };

    const product = products[productId];
    if (product) {
        // Enviar imagen del producto
        await sendImageMessage(to, product.image, "");
        
        // Enviar detalles con botones de acci√≥n
        const data = {
            messaging_product: 'whatsapp',
            to: to,
            type: 'interactive',
            interactive: {
                type: 'button',
                body: {
                    text: `${product.description}\n\nPrecio: ${product.price}`
                },
                action: {
                    buttons: [
                        {
                            type: 'reply',
                            reply: {
                                id: 'cotizar_producto',
                                title: 'üí∞ Cotizar'
                            }
                        },
                        {
                            type: 'reply',
                            reply: {
                                id: 'agendar_cita',
                                title: 'üìÖ Agendar Cita'
                            }
                        },
                        {
                            type: 'reply',
                            reply: {
                                id: 'ver_mas_productos',
                                title: 'üëÄ Ver M√°s'
                            }
                        }
                    ]
                }
            }
        };
        await sendMessageAPI(data);
    }
}

/**
 * Funci√≥n principal que demuestra el flujo completo de categor√≠as y productos.
 */
async function runTest() {
  console.log(`üöÄ Iniciando demostraci√≥n de cat√°logo interactivo para ${TO_PHONE_NUMBER}...`);

  // 1. Enviar PLANTILLA para abrir la ventana de 24 horas.
  console.log("Enviando plantilla 'hello_world' para iniciar la conversaci√≥n...");
  await sendMessageAPI({
    messaging_product: 'whatsapp',
    to: TO_PHONE_NUMBER,
    type: 'template',
    template: {
      name: 'hello_world',
      language: { code: 'en_US' }
    }
  });

  // Esperar un poco
  console.log("\nEsperando 10 segundos...");
  await new Promise(resolve => setTimeout(resolve, 10000));

  // 2. Enviar mensaje de bienvenida
  console.log("Enviando mensaje de bienvenida...");
  await sendTextMessage(TO_PHONE_NUMBER, "¬°Hola! Bienvenido a la demostraci√≥n del cat√°logo interactivo de Joyer√≠a Rimer üíé");

  await new Promise(resolve => setTimeout(resolve, 3000));

  // 3. Mostrar categor√≠as principales
  console.log("Mostrando categor√≠as principales...");
  await sendCategoriesMessage(TO_PHONE_NUMBER);

  await new Promise(resolve => setTimeout(resolve, 10000));

  // 4. Demo: Mostrar productos de Anillos
  console.log("Demostrando productos de Anillos...");
  await sendTextMessage(TO_PHONE_NUMBER, "Demo: Seleccionaste üíç Anillos");
  await sendAnillosProducts(TO_PHONE_NUMBER);

  await new Promise(resolve => setTimeout(resolve, 8000));

  // 5. Demo: Mostrar detalle de producto espec√≠fico
  console.log("Mostrando detalle del Anillo Solitario...");
  await sendTextMessage(TO_PHONE_NUMBER, "Demo: Seleccionaste 'Ver Solitario'");
  await sendProductDetail(TO_PHONE_NUMBER, 'prod_solitario');

  await new Promise(resolve => setTimeout(resolve, 10000));

  // 6. Demo: Mostrar otra categor√≠a (Cadenas)
  console.log("Demostrando productos de Cadenas...");
  await sendTextMessage(TO_PHONE_NUMBER, "Demo: Ahora veamos üîó Cadenas & Collares");
  await sendCadenasProducts(TO_PHONE_NUMBER);

  await new Promise(resolve => setTimeout(resolve, 8000));

  // 7. Demo: Mostrar producto de cadenas
  console.log("Mostrando detalle de Cadena Tenis...");
  await sendTextMessage(TO_PHONE_NUMBER, "Demo: Seleccionaste 'Ver Tenis'");
  await sendProductDetail(TO_PHONE_NUMBER, 'prod_tenis');

  await new Promise(resolve => setTimeout(resolve, 10000));

  // 8. Demo: Mostrar Aretes
  console.log("Demostrando productos de Aretes...");
  await sendTextMessage(TO_PHONE_NUMBER, "Demo: Finalmente veamos üíé Aretes");
  await sendAretesProducts(TO_PHONE_NUMBER);

  await new Promise(resolve => setTimeout(resolve, 8000));

  // 9. Mensaje final
  console.log("Enviando mensaje final...");
  await sendTextMessage(TO_PHONE_NUMBER, 
    "‚ú® ¬°Demo completada!\n\n" +
    "Este es el flujo que tendr√≠a un cliente:\n" +
    "1Ô∏è‚É£ Selecciona categor√≠a\n" +
    "2Ô∏è‚É£ Ve productos populares\n" +
    "3Ô∏è‚É£ Ve detalles espec√≠ficos\n" +
    "4Ô∏è‚É£ Puede cotizar o agendar cita\n\n" +
    "¬øTe gusta c√≥mo se ve? üòä"
  );

  console.log("\n‚úÖ Demostraci√≥n completa del cat√°logo interactivo finalizada.");
}

/**
 * Funci√≥n para probar solo las categor√≠as (sin la demo completa).
 */
async function testCategoriesOnly() {
    console.log("üîß Probando solo el sistema de categor√≠as...");
    
    // Enviar template primero
    await sendMessageAPI({
        messaging_product: 'whatsapp',
        to: TO_PHONE_NUMBER,
        type: 'template',
        template: {
            name: 'hello_world',
            language: { code: 'en_US' }
        }
    });
    
    await new Promise(resolve => setTimeout(resolve, 5000));
    
    // Mostrar categor√≠as
    await sendCategoriesMessage(TO_PHONE_NUMBER);
    
    console.log("‚úÖ Categor√≠as enviadas. Ahora puedes interactuar con los botones.");
}

/**
 * Funci√≥n para manejar respuestas de botones (simula el webhook).
 * Llama a esta funci√≥n manualmente con el ID del bot√≥n presionado.
 */
async function handleButtonResponse(buttonId) {
    console.log(`üîò Procesando respuesta del bot√≥n: ${buttonId}`);
    
    switch(buttonId) {
        case 'cat_anillos':
            await sendAnillosProducts(TO_PHONE_NUMBER);
            break;
        case 'cat_cadenas':
            await sendCadenasProducts(TO_PHONE_NUMBER);
            break;
        case 'cat_aretes':
            await sendAretesProducts(TO_PHONE_NUMBER);
            break;
        case 'prod_solitario':
        case 'prod_halo':
        case 'prod_eternidad':
        case 'prod_tenis':
        case 'prod_corazon':
        case 'prod_clasica':
        case 'prod_boton':
        case 'prod_colgante':
        case 'prod_aro':
            await sendProductDetail(TO_PHONE_NUMBER, buttonId);
            break;
        case 'cotizar_producto':
            await sendTextMessage(TO_PHONE_NUMBER, 
                "üí∞ ¬°Perfecto! Para enviarte una cotizaci√≥n personalizada necesito algunos datos:\n\n" +
                "üì± Nombre completo\nüìç Ciudad\nüíç Producto de inter√©s\nüíé Preferencias especiales\n\n" +
                "¬øTe parece si agendamos una cita para darte atenci√≥n personalizada?"
            );
            break;
        case 'agendar_cita':
            await sendTextMessage(TO_PHONE_NUMBER,
                "üìÖ ¬°Excelente! Para agendar tu cita necesito:\n\n" +
                "üóìÔ∏è Fecha preferida\n‚è∞ Hora conveniente\nüìç Sucursal (Centro o Norte)\nüíç Productos a ver\n\n" +
                "Responde con tu disponibilidad y coordinaremos todo üòä"
            );
            break;
        case 'ver_mas_productos':
            await sendCategoriesMessage(TO_PHONE_NUMBER);
            break;
        default:
            await sendTextMessage(TO_PHONE_NUMBER, "ü§î No reconozco esa opci√≥n. ¬øPuedes elegir una de las opciones disponibles?");
    }
}

// Puedes cambiar qu√© funci√≥n ejecutar:
// runTest();              // Demo completa autom√°tica
testCategoriesOnly();    // Solo muestra categor√≠as para interactuar manualmente

// Para probar respuestas de botones manualmente, descomenta y cambia el ID:
// handleButtonResponse('cat_anillos');  // Ejemplo: simula clic en "Anillos"