'use strict';

const axios = require('axios');

const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_NUMBER_ID = process.env.WHATSAPP_PHONE_NUMBER_ID;

/**
 * Funci√≥n base para enviar cualquier tipo de mensaje a la API Graph.
 * @param {object} data - El payload del mensaje a enviar.
 */
async function sendMessageAPI(data) {
    try {
        await axios({
            method: 'POST',
            url: `https://graph.facebook.com/v23.0/${WHATSAPP_PHONE_NUMBER_ID}/messages`,
            headers: {
                'Authorization': `Bearer ${WHATSAPP_TOKEN}`,
                'Content-Type': 'application/json'
            },
            data: data
        });
        console.log(`üì§ Mensaje enviado a ${data.to}`);
    } catch (error) {
        console.error('‚ùå Error al enviar mensaje a la API:', error.response ? JSON.stringify(error.response.data, null, 2) : error.message);
    }
}

/**
 * Env√≠a un mensaje de texto simple a trav√©s de la API de WhatsApp.
 * @param {string} to - El n√∫mero de tel√©fono del destinatario.
 * @param {string} text - El mensaje a enviar.
 */
async function sendTextMessage(to, text) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'text',
        text: { body: text }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje con una imagen desde una URL p√∫blica.
 * @param {string} to - El n√∫mero de tel√©fono del destinatario.
 * @param {string} imageUrl - La URL p√∫blica de la imagen (debe ser HTTPS).
 * @param {string} caption - El texto que acompa√±a a la imagen.
 */
async function sendImageMessage(to, imageUrl, caption) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'image',
        image: {
            link: imageUrl,
            caption: caption
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje de lista interactiva con productos.
 * @param {string} to - El n√∫mero de tel√©fono del destinatario.
 * @param {Array} products - Un array de objetos de producto de la base de datos.
 * @param {string} bodyText - El texto principal del mensaje.
 * @param {string} buttonText - El texto del bot√≥n para abrir la lista.
 */
async function sendProductListMessage(to, products, bodyText, buttonText) {
    if (!products || products.length === 0) {
        console.log("No hay productos para enviar en la lista.");
        return;
    }

    const rows = products.map(product => ({
        id: `product_${product._id}`, // Un ID √∫nico para cada opci√≥n
        title: product.name.substring(0, 24), // T√≠tulo de la fila (m√°x 24 caracteres)
        description: `${product.material} - $${product.price}`.substring(0, 72) // Descripci√≥n (m√°x 72 caracteres)
    }));

    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'list',
            header: {
                type: 'text',
                text: 'Nuestro Cat√°logo'
            },
            body: {
                text: bodyText
            },
            action: {
                button: buttonText,
                sections: [{ title: 'Anillos Disponibles', rows: rows }]
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje para iniciar un WhatsApp Flow.
 * @param {string} to - El n√∫mero de tel√©fono del destinatario.
 * @param {string} flowId - El ID de tu Flow publicado.
 * @param {string} cta - El texto del bot√≥n que inicia el Flow (Call to Action).
 * @param {string} screenId - El ID de la pantalla inicial del Flow.
 * @param {string} headerText - El texto del encabezado del mensaje.
 * @param {string} bodyText - El texto del cuerpo del mensaje.
 */
async function sendFlowMessage(to, flowId, cta, screenId, headerText, bodyText) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'flow',
            header: {
                type: 'text',
                text: headerText
            },
            body: {
                text: bodyText
            },
            footer: {
                text: 'Toca el bot√≥n para continuar'
            },
            action: {
                name: 'flow',
                parameters: {
                    flow_message_version: '3',
                    flow_id: flowId,
                    flow_cta: cta,
                    flow_action: 'navigate',
                    flow_action_payload: {
                        screen: screenId,
                    }
                }
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje interactivo con un √∫nico bot√≥n que abre un Flow.
 * @param {string} to - N√∫mero de tel√©fono del destinatario.
 * @param {string} bodyText - El texto principal del mensaje.
 * @param {string} buttonText - El texto que aparecer√° en el bot√≥n.
 * @param {string} flowId - El ID del Flow que se abrir√°.
 */
async function sendInteractiveFlowButton(to, bodyText, buttonText, flowId) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'flow',
            header: {
                type: 'text',
                text: '¬°Bienvenido a Joyer√≠a Rimer! üíé' // Un encabezado amigable
            },
            body: {
                text: bodyText
            },
            footer: {
                text: 'Tu joyer√≠a de confianza.' // Un pie de p√°gina opcional
            },
            action: {
                name: 'flow',
                parameters: {
                    flow_message_version: '3',
                    flow_id: flowId,
                    flow_cta: buttonText,
                    flow_action: 'navigate',
                    flow_action_payload: {
                        screen: 'WELCOME_SCREEN' // La pantalla inicial de tu Flow
                    }
                }
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje de plantilla.
 * @param {string} to - El n√∫mero de tel√©fono del destinatario.
 * @param {string} templateName - El nombre de la plantilla en Meta.
 * @param {string} languageCode - El c√≥digo de idioma de la plantilla (ej. 'es').
 * @param {string | null} headerImageUrl - La URL de la imagen para el encabezado (si la plantilla lo requiere).
 * @param {Array<string>} [bodyParams=[]] - Un array de strings para reemplazar las variables {{1}}, {{2}}, etc., en el cuerpo.
 */
async function sendTemplateMessage(to, templateName, languageCode, headerImageUrl = null, bodyParams = []) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'template',
        template: {
            name: templateName,
            language: {
                code: languageCode
            },
            components: []
        }
    };

    if (headerImageUrl) {
        data.template.components.push({
            type: 'header',
            parameters: [
                {
                    type: 'image',
                    image: { link: headerImageUrl }
                }
            ]
        });
    }

    if (bodyParams.length > 0) {
        data.template.components.push({
            type: 'body',
            parameters: bodyParams.map(param => ({
                type: 'text',
                text: param
            }))
        });
    }

    // Si no hay par√°metros, el array de componentes se env√≠a vac√≠o, lo cual es v√°lido.
    if (data.template.components.length === 0) {
        delete data.template.components;
    }

    await sendMessageAPI(data);
}

/**
 * Env√≠a un mensaje con categor√≠as principales de joyer√≠a.
 */
async function sendCategoriesMessage(to) {
    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: 'üíé ¬°Bienvenido a Joyer√≠a Rimer! ¬øQu√© tipo de joya te interesa?\n\nElige una categor√≠a para ver nuestros productos m√°s populares:'
            },
            action: {
                buttons: [
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_anillos',
                            title: 'üíç Anillos'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_cadenas',
                            title: 'üîó Cadenas & Collares'
                        }
                    },
                    {
                        type: 'reply',
                        reply: {
                            id: 'cat_aretes',
                            title: 'üíé Aretes'
                        }
                    }
                ]
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a productos populares de una categor√≠a espec√≠fica.
 */
async function sendCategoryProducts(to, category) {
    const categories = {
        'anillos': {
            title: 'üíç ANILLOS M√ÅS POPULARES',
            description: 'Descubre nuestras piezas m√°s solicitadas:\n\n‚ú® Anillo Solitario Cl√°sico - desde $2,500\n‚ú® Anillo de Compromiso Halo - desde $3,200\n‚ú® Anillo Eternidad - desde $1,800\n\n¬øCu√°l te interesa?',
            buttons: [
                { id: 'prod_solitario', title: 'Ver Solitario' },
                { id: 'prod_halo', title: 'Ver Halo' },
                { id: 'prod_eternidad', title: 'Ver Eternidad' }
            ]
        },
        'cadenas': {
            title: 'üîó CADENAS & COLLARES M√ÅS POPULARES',
            description: 'Nuestras piezas m√°s elegantes:\n\n‚ú® Cadena Tenis Diamante - desde $4,500\n‚ú® Collar Coraz√≥n Oro 18k - desde $1,200\n‚ú® Cadena Cl√°sica Oro - desde $800\n\n¬øCu√°l prefieres?',
            buttons: [
                { id: 'prod_tenis', title: 'Ver Tenis' },
                { id: 'prod_corazon', title: 'Ver Coraz√≥n' },
                { id: 'prod_clasica', title: 'Ver Cl√°sica' }
            ]
        },
        'aretes': {
            title: 'üíé ARETES M√ÅS POPULARES',
            description: 'Los favoritos de nuestras clientas:\n\n‚ú® Aretes Bot√≥n Diamante - desde $1,500\n‚ú® Aretes Colgantes Perla - desde $900\n‚ú® Aretes Aro Oro 18k - desde $650\n\n¬øCu√°l te gusta m√°s?',
            buttons: [
                { id: 'prod_boton', title: 'Ver Bot√≥n' },
                { id: 'prod_colgante', title: 'Ver Colgante' },
                { id: 'prod_aro', title: 'Ver Aro' }
            ]
        }
    };

    const categoryData = categories[category];
    if (!categoryData) return;

    const data = {
        messaging_product: 'whatsapp',
        to: to,
        type: 'interactive',
        interactive: {
            type: 'button',
            body: {
                text: categoryData.description
            },
            action: {
                buttons: categoryData.buttons.map(btn => ({
                    type: 'reply',
                    reply: {
                        id: btn.id,
                        title: btn.title
                    }
                }))
            }
        }
    };
    await sendMessageAPI(data);
}

/**
 * Env√≠a detalles de un producto espec√≠fico con imagen.
 */
async function sendProductDetail(to, productId) {
    const products = {
        'prod_solitario': {
            name: 'Anillo Solitario Cl√°sico',
            price: '$2,500 - $8,500',
            description: 'üíç ANILLO SOLITARIO CL√ÅSICO\n\n‚ú® Diamante central desde 0.5ct\nüî∂ Oro blanco, amarillo o ros√© 14k/18k\nüíé Certificado de autenticidad incluido\nüéÅ Perfecto para compromiso\n\n¬øTe interesa conocer m√°s detalles o agendar una cita para verlo?',
            image: 'https://github.com/user-attachments/assets/9c7e2e5f-4b7e-46b3-82c5-6d1b4e37a2e3'
        },
        'prod_halo': {
            name: 'Anillo de Compromiso Halo',
            price: '$3,200 - $12,000',
            description: 'üíç ANILLO HALO RADIANTE\n\n‚ú® Diamante central rodeado de peque√±os diamantes\nüî∂ Oro blanco 18k (disponible en otros metales)\nüíé Efecto de mayor brillo y tama√±o\nüéÅ Dise√±o rom√°ntico y elegante\n\n¬øTe gustar√≠a ver m√°s modelos o agendar una cita?',
            image: 'https://i.imgur.com/example-halo.jpg'
        },
        'prod_eternidad': {
            name: 'Anillo Eternidad',
            price: '$1,800 - $5,500',
            description: 'üíç ANILLO ETERNIDAD\n\n‚ú® Diamantes alrededor de toda la banda\nüî∂ Oro blanco o amarillo 14k/18k\nüíé S√≠mbolo de amor eterno\nüéÅ Ideal para aniversario o matrimonio\n\n¬øQuieres ver otras opciones o necesitas m√°s informaci√≥n?',
            image: 'https://i.imgur.com/example-eternidad.jpg'
        },
        'prod_tenis': {
            name: 'Cadena Tenis Diamante',
            price: '$4,500 - $15,000',
            description: 'üîó CADENA TENIS DIAMANTE\n\n‚ú® Diamantes de laboratorio o naturales\nüî∂ Oro blanco 18k con cierre de seguridad\nüíé Brillos incomparables\nüéÅ Elegancia para cualquier ocasi√≥n\n\n¬øTe interesa una cotizaci√≥n personalizada?',
            image: 'https://i.imgur.com/example-tenis.jpg'
        },
        'prod_corazon': {
            name: 'Collar Coraz√≥n Oro 18k',
            price: '$1,200 - $3,500',
            description: 'üîó COLLAR CORAZ√ìN ORO 18K\n\n‚ú® Dije en forma de coraz√≥n\nüî∂ Oro amarillo, blanco o ros√©\nüíé Opci√≥n con diamantes peque√±os\nüéÅ Regalo perfecto para ser querida\n\n¬øQuieres personalizarlo con grabado?',
            image: 'https://i.imgur.com/example-corazon.jpg'
        },
        'prod_clasica': {
            name: 'Cadena Cl√°sica Oro',
            price: '$800 - $2,200',
            description: 'üîó CADENA CL√ÅSICA ORO\n\n‚ú® Dise√±o atemporal y elegante\nüî∂ Oro 14k o 18k, varios largos\nüíé Perfecta para usar sola o con dije\nüéÅ B√°sico esencial en joyer√≠a\n\n¬øPrefieres verla en tienda o necesitas medidas?',
            image: 'https://i.imgur.com/example-clasica.jpg'
        },
        'prod_boton': {
            name: 'Aretes Bot√≥n Diamante',
            price: '$1,500 - $4,500',
            description: 'üíé ARETES BOT√ìN DIAMANTE\n\n‚ú® Diamantes de laboratorio o naturales\nüî∂ Oro blanco, amarillo o ros√©\nüíé Elegantes y vers√°tiles\nüéÅ Perfectos para uso diario\n\n¬øTe gustar√≠a ver diferentes tama√±os?',
            image: 'https://i.imgur.com/example-boton.jpg'
        },
        'prod_colgante': {
            name: 'Aretes Colgantes Perla',
            price: '$900 - $2,800',
            description: 'üíé ARETES COLGANTES PERLA\n\n‚ú® Perlas de cultivo de alta calidad\nüî∂ Oro 14k o 18k\nüíé Movimiento elegante\nüéÅ Ideales para ocasiones especiales\n\n¬øPrefieres perlas blancas o doradas?',
            image: 'https://i.imgur.com/example-colgante.jpg'
        },
        'prod_aro': {
            name: 'Aretes Aro Oro 18k',
            price: '$650 - $1,800',
            description: 'üíé ARETES ARO ORO 18K\n\n‚ú® Dise√±o cl√°sico atemporal\nüî∂ Oro amarillo, blanco o ros√©\nüíé Diferentes di√°metros disponibles\nüéÅ B√°sicos esenciales\n\n¬øQu√© tama√±o prefieres?',
            image: 'https://i.imgur.com/example-aro.jpg'
        }
    };

    const product = products[productId];
    if (product) {
        // Enviar imagen del producto primero
        await sendImageMessage(to, product.image, "");
        
        // Luego enviar detalles con botones de acci√≥n
        const data = {
            messaging_product: 'whatsapp',
            to: to,
            type: 'interactive',
            interactive: {
                type: 'button',
                body: {
                    text: `${product.description}\n\nPrecio: ${product.price}`
                },
                action: {
                    buttons: [
                        {
                            type: 'reply',
                            reply: {
                                id: 'cotizar_producto',
                                title: 'üí∞ Cotizar'
                            }
                        },
                        {
                            type: 'reply',
                            reply: {
                                id: 'agendar_cita',
                                title: 'üìÖ Agendar Cita'
                            }
                        },
                        {
                            type: 'reply',
                            reply: {
                                id: 'ver_mas_productos',
                                title: 'üëÄ Ver M√°s'
                            }
                        }
                    ]
                }
            }
        };
        await sendMessageAPI(data);
    }
}


module.exports = {
    sendTextMessage,
    sendImageMessage,
    sendProductListMessage,
    sendFlowMessage,
    sendTemplateMessage,
    sendInteractiveFlowButton,
    sendCategoriesMessage,
    sendCategoryProducts,
    sendProductDetail
};